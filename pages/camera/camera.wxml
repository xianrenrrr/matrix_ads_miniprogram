<!-- pages/camera/camera.wxml -->
<view class="camera-container">
  <!-- 相机预览容器 -->
  <view id="previewContainer" class="preview-container">
    <!-- 相机预览 -->
    <camera 
      class="camera-preview"
      device-position="{{cameraPosition}}"
      flash="{{flashMode}}"
      binderror="onCameraError"
    >
    <!-- UI Wrapper - rotates for landscape, camera feed stays normal -->
    <view class="{{isLandscape ? 'camera-ui-landscape' : ''}}">
    <!-- 网格覆盖 -->
    <view wx:if="{{showOverlay && selectedTemplate && overlayType === 'grid'}}" class="grid-overlay" style="pointer-events: none;">
      <view class="grid-line grid-line-v1"></view>
      <view class="grid-line grid-line-v2"></view>
      <view class="grid-line grid-line-h1"></view>
      <view class="grid-line grid-line-h2"></view>
      
      <!-- 九宫格场景提示 -->
      <view class="scene-hints">
        <view 
          wx:for="{{gridOverlay}}" 
          wx:key="index"
          class="grid-block grid-block-{{item}} active"
          data-grid="{{item}}"
        >
          <text wx:if="{{gridLabels[index]}}" class="grid-label">{{gridLabels[index]}}</text>
        </view>
      </view>
    </view>

    <!-- 多边形覆盖 -->
    <view wx:if="{{showOverlay && selectedTemplate && overlayType === 'polygons'}}" class="polygon-overlay" style="pointer-events: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: 5;">
      <canvas 
        canvas-id="polygonCanvas"
        class="overlay-canvas"
        disable-scroll="true"
        style="width: 100%; height: 100%;"
      ></canvas>
    </view>

    <!-- 对象覆盖层 (MVP: Canvas based) -->
    <view wx:if="{{showOverlay && selectedTemplate && overlayType === 'objects'}}" id="overlayLayer" class="overlay-layer" style="pointer-events: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: 5;">
      <canvas canvas-id="overlayCanvas" id="overlayCanvas" style="width: 100%; height: 100%;"></canvas>
    </view>

    <!-- KeyElements 覆盖层 (Bounding Boxes) -->
    <view wx:if="{{showOverlay && overlayRectsPixels.length > 0}}" class="keyelements-overlay" style="pointer-events: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: 5;">
      <view 
        wx:for="{{overlayRectsPixels}}" 
        wx:key="index"
        class="box-overlay"
        style="position: absolute; left: {{item.left}}px; top: {{item.top}}px; width: {{item.width}}px; height: {{item.height}}px; border: 3px solid {{item.colorHex}}; border-radius: 4px;"
      >
        <text class="box-label" style="position: absolute; top: 2px; left: 2px; background: {{item.colorHex}}; color: white; padding: 2px 6px; border-radius: 3px; font-size: 11px; white-space: nowrap; max-width: calc(100% - 8px); overflow: hidden; text-overflow: ellipsis;">{{item.name}}</text>
      </view>
    </view>

    <!-- 录制状态指示器 -->
    <view wx:if="{{isRecording}}" class="recording-indicator">
      <view class="recording-dot"></view>
      <text class="recording-text">{{t('recording')}}</text>
    </view>

    <!-- 录制时间显示 (inside camera for rotation, only show in landscape) -->
    <view wx:if="{{selectedTemplate && isLandscape}}" class="recording-timer-in-camera">
      <text class="timer-text">{{recordTime}}秒 / {{maxRecordTime}}秒</text>
      <text wx:if="{{isRecording}}" class="remaining-text">剩余 {{maxRecordTime - recordTime}}秒</text>
    </view>

    <!-- 顶部控制栏 -->
    <view class="top-controls">
      <view class="control-btn back-btn" bindtap="goBack">
        <text class="control-icon">←</text>
      </view>
    </view>

    <!-- 右侧控制栏 -->
    <view class="right-controls {{showHints ? 'shifted-left' : ''}}">
      <view class="control-btn" bindtap="toggleFlash">
        <text class="control-icon">⚡</text>
        <text class="control-label">闪光</text>
      </view>
      <view class="control-btn" bindtap="switchCamera">
        <text class="control-icon">↻</text>
        <text class="control-label">翻转</text>
      </view>
      <view class="control-btn" bindtap="toggleOverlay">
        <text class="control-icon">⊞</text>
        <text class="control-label">辅助线</text>
      </view>
      <view class="control-btn" bindtap="toggleKtv">
        <text class="control-icon">♪</text>
        <text class="control-label">提词器</text>
      </view>
      <view class="control-btn" bindtap="toggleHints">
        <text class="control-icon">{{showHints ? '>' : '<'}}</text>
        <text class="control-label">指导</text>
      </view>
    </view>

    <!-- KTV提词器覆盖层：底部显示逐字高亮 -->
    <view wx:if="{{showKtv && currentScript}}" class="ktv-overlay">
      <text class="ktv-text">
        <text class="ktv-highlight">{{ktvHighlighted}}</text><text class="ktv-rest">{{ktvRest}}</text>
      </text>
    </view>

    </view> <!-- end camera-ui-landscape wrapper -->
  </camera>
  </view> <!-- end of previewContainer -->

  <!-- 指导侧边栏 -->
  <view class="hints-sidebar {{showHints ? 'show' : ''}}">
    <view class="hints-content">
      <view class="hints-section">
        <text class="hints-title">设备信息</text>
        <view class="hints-details">
          <text class="hints-detail">手机比例: {{sourceAspect || '9:16'}}</text>
          <text class="hints-detail" wx:if="{{deviceOrientationText}}">方向: {{deviceOrientationText}}</text>
        </view>
      </view>

      <view class="hints-section" wx:if="{{backgroundInstructions}}">
        <text class="hints-title">背景要求</text>
        <text class="hints-text">{{backgroundInstructions}}</text>
      </view>

      <view class="hints-section" wx:if="{{cameraInstructions}}">
        <text class="hints-title">拍摄指导</text>
        <text class="hints-text">{{cameraInstructions}}</text>
      </view>

      <view class="hints-section" wx:if="{{movementInstructions}}">
        <text class="hints-title">运镜要求</text>
        <text class="hints-text">{{movementInstructions}}</text>
      </view>

      <view class="hints-section" wx:if="{{audioNotesText}}">
        <text class="hints-title">音频备注</text>
        <text class="hints-text">{{audioNotesText}}</text>
      </view>
    </view>
  </view>
  


  <!-- 底部控制栏 -->
  <view class="bottom-controls">
    <!-- 录制时间显示 (hide in landscape mode) -->
    <view wx:if="{{selectedTemplate && !isLandscape}}" class="recording-timer">
      <text class="timer-text">{{recordTime}}秒 / {{maxRecordTime}}秒</text>
      <text wx:if="{{isRecording}}" class="remaining-text">剩余 {{maxRecordTime - recordTime}}秒</text>
    </view>

    <!-- 录制按钮 -->
    <view class="record-controls">
      <button
        wx:if="{{!isRecording && !currentRecording}}"
        class="record-btn record-btn-start"
        bindtap="startRecording"
        disabled="{{!selectedTemplate}}"
      >
        <view class="record-icon"></view>
      </button>

      <button
        wx:elif="{{isRecording}}"
        class="record-btn record-btn-stop"
        bindtap="stopRecording"
      >
        <view class="stop-icon"></view>
      </button>
    </view>

  </view>

  <!-- 录制完成弹窗 -->
  <view wx:if="{{showRecordingCompleteModal}}" class="recording-complete-overlay">
    <view class="recording-complete-modal">
      <view class="recording-complete-header">
        <text class="recording-complete-title">录制完成</text>
      </view>
      <view class="recording-complete-body">
        <text class="recording-complete-text">场景录制成功！</text>
        <text class="recording-complete-duration">时长: {{recordTime}}秒</text>
      </view>
      <view class="recording-complete-actions">
        <button class="recording-action-btn retry-btn" bindtap="retakeCurrentScene">重新录制</button>
        <button class="recording-action-btn submit-btn" bindtap="submitScene">提交场景</button>
      </view>
    </view>
  </view>



  <!-- 模板选择提示 -->
  <view wx:if="{{!selectedTemplate}}" class="template-prompt">
    <view class="prompt-content">
      <text class="prompt-title">{{t('selectTemplate')}}</text>
      <text class="prompt-desc">{{t('selectTemplateDesc')}}</text>
      <button class="prompt-btn" bindtap="showTemplateSelector">
        {{t('chooseTemplate')}}
      </button>
    </view>
  </view>
</view>
