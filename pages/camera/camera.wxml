<!-- pages/camera/camera.wxml -->
<view class="camera-container">
  <!-- ç›¸æœºé¢„è§ˆ -->
  <camera 
    class="camera-preview"
    device-position="{{cameraPosition}}"
    flash="{{flashMode}}"
    binderror="onCameraError"
  >
    <!-- ç½‘æ ¼è¦†ç›– -->
    <view wx:if="{{showOverlay && selectedTemplate}}" class="grid-overlay">
      <view class="grid-line grid-line-v1"></view>
      <view class="grid-line grid-line-v2"></view>
      <view class="grid-line grid-line-h1"></view>
      <view class="grid-line grid-line-h2"></view>
      
      <!-- ä¹å®«æ ¼åœºæ™¯æç¤º -->
      <view class="scene-hints">
        <view 
          wx:for="{{gridOverlay}}" 
          wx:key="index"
          class="grid-block grid-block-{{item}} active"
          data-grid="{{item}}"
        >
          <text wx:if="{{gridLabels[index]}}" class="grid-label">{{gridLabels[index]}}</text>
        </view>
      </view>
    </view>

    <!-- å½•åˆ¶çŠ¶æ€æŒ‡ç¤ºå™¨ -->
    <view wx:if="{{isRecording}}" class="recording-indicator">
      <view class="recording-dot"></view>
      <text class="recording-text">å½•åˆ¶ä¸­</text>
    </view>

    <!-- åœºæ™¯ä¿¡æ¯ -->
    <view wx:if="{{selectedTemplate}}" class="scene-info">
      <view class="scene-title">
        åœºæ™¯ {{currentScene + 1}}/{{selectedTemplate.scenes.length}}: 
        {{selectedTemplate.scenes[currentScene].sceneTitle}}
      </view>
      <view class="scene-time">
        {{recordTime}}s / {{selectedTemplate.scenes[currentScene].sceneDuration || maxRecordTime}}s
      </view>
    </view>

    <!-- é¡¶éƒ¨æ§åˆ¶æ  -->
    <view class="top-controls">
      <view class="control-btn back-btn" bindtap="goBack">
        <text class="control-icon">â†</text>
      </view>
      <view class="controls-right">
        <view class="control-btn" bindtap="toggleFlash">
          <text class="control-icon">{{flashMode === 'off' ? 'ğŸ”¦' : flashMode === 'on' ? 'ğŸ’¡' : 'âš¡'}}</text>
        </view>
        <view class="control-btn" bindtap="switchCamera">
          <text class="control-icon">ğŸ”„</text>
        </view>
        <view class="control-btn" bindtap="toggleOverlay">
          <text class="control-icon">{{showOverlay ? 'ğŸ“' : 'ğŸ“'}}</text>
        </view>
      </view>
    </view>
  </camera>

  <!-- è„šæœ¬ä¾§è¾¹æ  -->
  <view wx:if="{{selectedTemplate && currentScript}}" class="script-sidebar {{showScriptSidebar ? 'show' : ''}}">
    <view class="script-toggle" bindtap="toggleScriptSidebar">
      <text>{{showScriptSidebar ? '>' : '<'}}</text>
    </view>
    <view class="script-content">
      <text class="script-text">{{selectedTemplate.scenes[currentScene].scriptLine}}</text>
      <view class="script-details">
        <text class="script-detail">ğŸ“ äººç‰©ä½ç½®: {{selectedTemplate.scenes[currentScene].personPosition || 'æœªæŒ‡å®š'}}</text>
        <text class="script-detail">ğŸ¬ åŠ¨ä½œæŒ‡å¯¼: {{selectedTemplate.scenes[currentScene].movementInstructions || 'æ— ç‰¹æ®Šè¦æ±‚'}}</text>
        <text class="script-detail">ğŸ“· æ‘„åƒè¦æ±‚: {{selectedTemplate.scenes[currentScene].specificCameraInstructions || 'æŒ‰æ¨¡æ¿æ‹æ‘„'}}</text>
      </view>
    </view>
  </view>


  <!-- åº•éƒ¨æ§åˆ¶æ  -->
  <view class="bottom-controls">
    <!-- åœºæ™¯è¿›åº¦æŒ‡ç¤ºå™¨ -->
    <view wx:if="{{selectedTemplate}}" class="scene-progress-indicator">
      <view 
        wx:for="{{selectedTemplate.scenes}}" 
        wx:key="index"
        class="progress-dot {{index === currentScene ? 'active' : ''}} {{recordedVideos[index] ? 'completed' : ''}}"
      ></view>
    </view>

    <!-- å½•åˆ¶æŒ‰é’® -->
    <view class="record-controls">
      <button 
        wx:if="{{!isRecording && !recordedVideos[currentScene]}}"
        class="record-btn record-btn-start"
        bindtap="startRecording"
        disabled="{{!selectedTemplate}}"
      >
        <view class="record-icon"></view>
      </button>
      
      <button 
        wx:elif="{{isRecording}}"
        class="record-btn record-btn-stop"
        bindtap="stopRecording"
      >
        <view class="stop-icon"></view>
      </button>
    </view>

  </view>

  <!-- å½•åˆ¶å®Œæˆå¼¹çª— -->
  <view wx:if="{{showRecordingCompleteModal}}" class="recording-complete-overlay">
    <view class="recording-complete-modal">
      <view class="recording-complete-header">
        <text class="recording-complete-title">å½•åˆ¶å®Œæˆ</text>
      </view>
      <view class="recording-complete-body">
        <text class="recording-complete-text">åœºæ™¯ {{currentScene + 1}} å½•åˆ¶å®Œæˆ</text>
      </view>
      <view class="recording-complete-actions">
        <button class="recording-action-btn retry-btn" bindtap="retakeCurrentScene">
          é‡æ–°å½•åˆ¶
        </button>
        <button 
          wx:if="{{currentScene < selectedTemplate.scenes.length - 1}}"
          class="recording-action-btn continue-btn" 
          bindtap="continueToNextScene"
        >
          ç»§ç»­
        </button>
        <button 
          wx:else
          class="recording-action-btn finish-btn" 
          bindtap="finishAllRecording"
        >
          å®Œæˆå½•åˆ¶
        </button>
      </view>
    </view>
  </view>

  <!-- ä¸Šä¼ å¤±è´¥å¼¹çª— -->
  <view wx:if="{{showUploadFailureModal}}" class="upload-failure-overlay">
    <view class="upload-failure-modal">
      <view class="upload-failure-header">
        <text class="upload-failure-title">ä¸Šä¼ å¤±è´¥</text>
      </view>
      <view class="upload-failure-body">
        <text class="upload-failure-text">è§†é¢‘ä¸Šä¼ é‡åˆ°é—®é¢˜ï¼Œæ‚¨å¯ä»¥é€‰æ‹©é‡è¯•æˆ–ä¸‹è½½åˆ°æœ¬åœ°</text>
        <text class="upload-failure-detail">{{uploadErrorMessage}}</text>
      </view>
      <view class="upload-failure-actions">
        <button class="upload-action-btn download-btn" bindtap="downloadVideoToLocal">
          ä¸‹è½½åˆ°æœ¬åœ°
        </button>
        <button class="upload-action-btn retry-btn" bindtap="retryUpload">
          é‡è¯•ä¸Šä¼ 
        </button>
      </view>
    </view>
  </view>

  <!-- æ¨¡æ¿é€‰æ‹©æç¤º -->
  <view wx:if="{{!selectedTemplate}}" class="template-prompt">
    <view class="prompt-content">
      <text class="prompt-title">è¯·é€‰æ‹©å½•åˆ¶æ¨¡æ¿</text>
      <text class="prompt-desc">é€‰æ‹©åˆé€‚çš„æ¨¡æ¿å¼€å§‹å½•åˆ¶</text>
      <button class="prompt-btn" bindtap="showTemplateSelector">
        é€‰æ‹©æ¨¡æ¿
      </button>
    </view>
  </view>
</view>