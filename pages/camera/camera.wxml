<!-- pages/camera/camera.wxml -->
<view class="camera-container">
  <!-- Áõ∏Êú∫È¢ÑËßàÂÆπÂô® -->
  <view id="previewContainer" class="preview-container">
    <!-- Áõ∏Êú∫È¢ÑËßà -->
    <camera 
      class="camera-preview"
      device-position="{{cameraPosition}}"
      flash="{{flashMode}}"
      binderror="onCameraError"
    >
    <!-- ÁΩëÊ†ºË¶ÜÁõñ -->
    <view wx:if="{{showOverlay && selectedTemplate && overlayType === 'grid'}}" class="grid-overlay">
      <view class="grid-line grid-line-v1"></view>
      <view class="grid-line grid-line-v2"></view>
      <view class="grid-line grid-line-h1"></view>
      <view class="grid-line grid-line-h2"></view>
      
      <!-- ‰πùÂÆ´Ê†ºÂú∫ÊôØÊèêÁ§∫ -->
      <view class="scene-hints">
        <view 
          wx:for="{{gridOverlay}}" 
          wx:key="index"
          class="grid-block grid-block-{{item}} active"
          data-grid="{{item}}"
        >
          <text wx:if="{{gridLabels[index]}}" class="grid-label">{{gridLabels[index]}}</text>
        </view>
      </view>
    </view>

    <!-- Â§öËæπÂΩ¢Ë¶ÜÁõñ -->
    <view wx:if="{{showOverlay && selectedTemplate && overlayType === 'polygons'}}" class="polygon-overlay">
      <canvas 
        canvas-id="polygonCanvas"
        class="overlay-canvas"
        disable-scroll="true"
      ></canvas>
    </view>

    <!-- ÂØπË±°Ë¶ÜÁõñ (Êîπ‰∏∫ÈùûÈòªÂ°û) -->
    <view wx:if="{{showOverlay && selectedTemplate && overlayType === 'objects'}}" class="object-overlay">
      <view 
        wx:for="{{objectOverlayPixels}}" 
        wx:key="index"
        class="object-box"
        style="left: {{item.left}}px; top: {{item.top}}px; width: {{item.width}}px; height: {{item.height}}px; border-color: {{item.color}};"
      >
        <view class="object-label" style="background-color: {{item.color}};">
          <text class="object-label-text">{{item.labelLocalized || item.label}}</text>
        </view>
      </view>
    </view>

    <!-- ÂΩïÂà∂Áä∂ÊÄÅÊåáÁ§∫Âô® -->
    <view wx:if="{{isRecording}}" class="recording-indicator">
      <view class="recording-dot"></view>
      <text class="recording-text">{{t('recording')}}</text>
    </view>

    <!-- Âú∫ÊôØ‰ø°ÊÅØ -->
    <view wx:if="{{selectedTemplate}}" class="scene-info">
      <view class="scene-title">
        {{t('scene')}} {{sceneNumber}}: {{selectedTemplate.scenes[sceneIndex].sceneTitle}}
      </view>
      <view class="scene-time">
        {{recordTime}}{{t('secondsShort')}} / {{selectedTemplate.scenes[sceneIndex].sceneDurationInSeconds || maxRecordTime}}{{t('secondsShort')}}
      </view>
    </view>

    <!-- È°∂ÈÉ®ÊéßÂà∂Ê†è -->
    <view class="top-controls">
      <view class="control-btn back-btn" bindtap="goBack">
        <text class="control-icon">‚Üê</text>
      </view>
      <view class="controls-right">
        <view class="control-btn" bindtap="toggleFlash">
          <text class="control-icon">{{flashMode === 'off' ? 'üî¶' : flashMode === 'on' ? 'üí°' : '‚ö°'}}</text>
        </view>
        <view class="control-btn" bindtap="switchCamera">
          <text class="control-icon">üîÑ</text>
        </view>
        <view class="control-btn" bindtap="toggleOverlay">
          <text class="control-icon">{{showOverlay ? 'üìè' : 'üìê'}}</text>
        </view>
      </view>
    </view>
  </camera>
  </view> <!-- end of previewContainer -->
  
  <!-- Âõæ‰æã‰æßËæπÊ†è -->
  <view wx:if="{{legend && legend.length > 0 && showOverlay}}" class="legend-sidebar">
    <view wx:for="{{legend}}" wx:key="index" class="legend-item">
      <view class="legend-dot" style="background-color: {{item.colorHex}};"></view>
      <text class="legend-label">{{item.labelLocalized || item.label}}</text>
      <text class="legend-confidence">{{(item.confidence * 100).toFixed(0)}}%</text>
    </view>
  </view>

  <!-- ËÑöÊú¨‰æßËæπÊ†è -->
  <view wx:if="{{selectedTemplate && currentScript}}" class="script-sidebar {{showScriptSidebar ? 'show' : ''}}">
    <view class="script-toggle" bindtap="toggleScriptSidebar">
      <text>{{showScriptSidebar ? '>' : '<'}}</text>
    </view>
    <view class="script-content">
      <text class="script-text">{{selectedTemplate.scenes[sceneIndex].scriptLine}}</text>
      <view class="script-details">
        <text class="script-detail">üìç {{t('personPosition')}}: {{selectedTemplate.scenes[sceneIndex].personPosition || t('unspecified')}}</text>
        <text class="script-detail">üé¨ {{t('movementInstructions')}}: {{selectedTemplate.scenes[sceneIndex].movementInstructions || t('noSpecialRequirements')}}</text>
        <text class="script-detail">üì∑ {{t('cameraInstructions')}}: {{selectedTemplate.scenes[sceneIndex].specificCameraInstructions || t('followTemplate')}}</text>
      </view>
    </view>
  </view>


  <!-- Â∫ïÈÉ®ÊéßÂà∂Ê†è -->
  <view class="bottom-controls">
    <!-- ÂΩïÂà∂ÊåâÈíÆ -->
    <view class="record-controls">
      <button 
        wx:if="{{!isRecording && !currentRecording}}"
        class="record-btn record-btn-start"
        bindtap="startRecording"
        disabled="{{!selectedTemplate}}"
      >
        <view class="record-icon"></view>
      </button>
      
      <button 
        wx:elif="{{isRecording}}"
        class="record-btn record-btn-stop"
        bindtap="stopRecording"
      >
        <view class="stop-icon"></view>
      </button>
    </view>

  </view>

  <!-- ÂΩïÂà∂ÂÆåÊàêÂºπÁ™ó -->
  <view wx:if="{{showRecordingCompleteModal}}" class="recording-complete-overlay">
    <view class="recording-complete-modal">
      <view class="recording-complete-header">
        <text class="recording-complete-title">{{recordingCompleteText}}</text>
      </view>
      <view class="recording-complete-body">
        <text class="recording-complete-text">{{recordingCompleteMessageText}}</text>
        <text class="recording-complete-duration">{{durationText}}: {{recordTime}}{{secondsShortText}}</text>
      </view>
      <view class="recording-complete-actions">
        <button class="recording-action-btn retry-btn" bindtap="retakeCurrentScene">
          {{reRecordText}}
        </button>
        <button class="recording-action-btn submit-btn" bindtap="submitScene">
          {{submitSceneText}}
        </button>
      </view>
    </view>
  </view>


  <!-- Ê®°ÊùøÈÄâÊã©ÊèêÁ§∫ -->
  <view wx:if="{{!selectedTemplate}}" class="template-prompt">
    <view class="prompt-content">
      <text class="prompt-title">{{t('selectTemplate')}}</text>
      <text class="prompt-desc">{{t('selectTemplateDesc')}}</text>
      <button class="prompt-btn" bindtap="showTemplateSelector">
        {{t('chooseTemplate')}}
      </button>
    </view>
  </view>
</view>