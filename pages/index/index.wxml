<!-- pages/index/index.wxml -->
<view class="page-container">
  <!-- 头部 -->
  <view class="header">
    <text class="header-title">Xpectra AI</text>
  </view>

  <!-- 加载状态 -->
  <view wx:if="{{loading}}" class="loading">
    <view class="loading-spinner"></view>
  </view>

  <!-- 主要内容 -->
  <view wx:else class="container">
    <!-- 欢迎信息 -->
    <view class="card card-flush full-bleed">
      <view>
        <view class="greeting-box">
          <view class="title-row">
            <image class="greeting-pin" src="/assets/Frame@2x.png" mode="aspectFit" />
            <view class="title-texts">
              <view class="card-title home-title">您好！{{userInfo.username || '用户'}}</view>
              <view wx:if="{{managerName}}" class="manager-name">管理员：{{managerName}}</view>
              <view class="card-subtitle home-subtitle">开始今天的创作吧!</view>
              <image class="greeting-illustration" src="/assets/Mask group@3x.png" mode="aspectFit" />
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- Tabs -->
    <view class="tabs-container">
      <view class="tab {{activeTab === 'pending' ? 'tab-active' : ''}}" bindtap="switchTab" data-tab="pending">
        <text>待录制</text>
      </view>
      <view class="tab {{activeTab === 'toDownload' ? 'tab-active' : ''}}" bindtap="switchTab" data-tab="toDownload">
        <text>待下载</text>
        <view wx:if="{{toDownloadCount > 0}}" class="tab-badge">{{toDownloadCount}}</view>
      </view>
      <view class="tab {{activeTab === 'downloaded' ? 'tab-active' : ''}}" bindtap="switchTab" data-tab="downloaded">
        <text>已下载</text>
      </view>
    </view>

    <!-- 待录制 列表 -->
    <view wx:if="{{activeTab === 'pending' && pendingTemplates.length > 0}}" class="tpl-grid full-bleed">
      <view
        wx:for="{{pendingTemplates}}"
        wx:key="id"
        class="tpl-card"
        data-id="{{item.id}}"
        bindtap="selectTemplate"
      >
        <view class="tpl-thumb">
          <image wx:if="{{item.thumbnail}}" src="{{item.thumbnail}}" mode="aspectFill" class="tpl-thumb-img" />
          <view wx:else class="tpl-thumb-placeholder"></view>
        </view>
        <view class="tpl-title {{item._titleClass}}">{{item.templateTitle || '未命名模板'}}</view>
        <view class="tpl-meta">
          <view class="meta-item"><text class="meta-dot"></text><text>场景{{item.sceneCount || 0}}</text></view>
          <view class="meta-item"><text class="meta-dot"></text><text>{{item.totalVideoLength || 0}}秒</text></view>
          <view wx:if="{{item.daysUntilExpiry > 0}}" class="meta-item"><text class="meta-dot"></text><text>剩余{{item.daysUntilExpiry}}天</text></view>
        </view>
        <view class="tpl-actions">
          <custom-button
            text="开始录制"
            type="danger-outline"
            size="default"
            ext-class="block-btn"
            data-id="{{item.id}}"
            catch:tap="selectTemplate"
          />
        </view>
      </view>
    </view>

    <!-- 待下载 列表 -->
    <view wx:if="{{activeTab === 'toDownload' && toDownloadVideos.length > 0}}" class="tpl-grid full-bleed">
      <view
        wx:for="{{toDownloadVideos}}"
        wx:key="id"
        class="tpl-card"
      >
        <view class="tpl-thumb">
          <image wx:if="{{item.thumbnailUrl}}" src="{{item.thumbnailUrl}}" mode="aspectFill" class="tpl-thumb-img" />
          <view wx:else class="tpl-thumb-placeholder"></view>
        </view>
        <view class="tpl-title {{item._titleClass}}">{{item.templateTitle || '未命名模板'}}</view>
        <view class="tpl-meta">
          <view class="meta-item"><text class="meta-dot"></text><text>场景{{item.sceneCount || 0}}</text></view>
          <view class="meta-item"><text class="meta-dot"></text><text>{{item.totalDuration || 0}}秒</text></view>
        </view>
        <view class="tpl-actions">
          <custom-button
            text="下载视频"
            type="success-outline"
            size="default"
            ext-class="block-btn"
            data-url="{{item.compiledVideoUrl}}"
            data-id="{{item.id}}"
            catch:tap="downloadVideo"
          />
        </view>
      </view>
    </view>

    <!-- 已下载 列表 -->
    <view wx:if="{{activeTab === 'downloaded' && downloadedVideos.length > 0}}" class="tpl-grid full-bleed">
      <view
        wx:for="{{downloadedVideos}}"
        wx:key="id"
        class="tpl-card"
      >
        <view class="tpl-thumb">
          <image wx:if="{{item.thumbnailUrl}}" src="{{item.thumbnailUrl}}" mode="aspectFill" class="tpl-thumb-img" />
          <view wx:else class="tpl-thumb-placeholder"></view>
        </view>
        <view class="tpl-title {{item._titleClass}}">{{item.templateTitle || '未命名模板'}}</view>
        <view class="tpl-meta">
          <view class="meta-item"><text class="meta-dot"></text><text>场景{{item.sceneCount || 0}}</text></view>
          <view class="meta-item"><text class="meta-dot"></text><text>{{item.totalDuration || 0}}秒</text></view>
        </view>
        <view class="tpl-actions">
          <custom-button
            text="下载视频"
            type="success-outline"
            size="default"
            ext-class="block-btn"
            data-url="{{item.compiledVideoUrl}}"
            data-id="{{item.id}}"
            catch:tap="downloadVideo"
          />
        </view>
      </view>
    </view>

    <!-- Empty States -->
    <view wx:if="{{activeTab === 'pending' && pendingTemplates.length === 0}}" class="empty-state">
      <text class="empty-text">暂无待录制模板</text>
    </view>
    <view wx:if="{{activeTab === 'toDownload' && toDownloadVideos.length === 0}}" class="empty-state">
      <text class="empty-text">暂无待下载视频</text>
    </view>
    <view wx:if="{{activeTab === 'downloaded' && downloadedVideos.length === 0}}" class="empty-state">
      <text class="empty-text">暂无已下载视频</text>
    </view>

    <!-- 退出登录 CTA -->
    <view class="logout-cta" bindtap="handleLogout">退出登录</view>
  </view>
</view>
