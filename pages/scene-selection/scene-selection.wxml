<!--pages/scene-selection/scene-selection.wxml-->
<view class="scene-selection-container">

  <!-- 头部 -->
  <view class="header">
    <view class="back-btn" bindtap="goBack">
      <text class="back-icon">‹</text>
    </view>
    <text class="header-title">模板详情</text>
  </view>

  <!-- Loading State -->
  <view class="loading-container" wx:if="{{loading}}">
    <view class="loading-spinner"></view>
    <text class="loading-text">{{t('loadingScenes')}}</text>
  </view>

  <!-- Template Info -->
  <view class="template-info" wx:if="{{!loading && template}}">
    <view class="info-card">
      <text class="info-title">{{t('templateInfo')}}</text>
      <text class="info-description">{{template.templateDescription || '请按照具体说明录制每个场景'}}</text>

      <!-- Common video information -->
      <view class="common-info">
        <view class="info-row" wx:if="{{templateDisplay && templateDisplay.videoPurpose}}">
          <text class="info-label">视频目标：</text>
          <text class="info-value">{{templateDisplay.videoPurpose}}</text>
        </view>
        <view class="info-row" wx:if="{{templateDisplay && templateDisplay.tone}}">
          <text class="info-label">语调：</text>
          <text class="info-value">{{templateDisplay.tone}}</text>
        </view>
        <view class="info-row" wx:if="{{templateDisplay && templateDisplay.totalVideoLength}}">
          <text class="info-label">总视频时长：</text>
          <text class="info-value">{{templateDisplay.totalVideoLength}} 秒</text>
        </view>
        <view class="info-row" wx:if="{{templateDisplay && templateDisplay.videoFormat}}">
          <text class="info-label">视频格式：</text>
          <text class="info-value">{{templateDisplay.videoFormat}}</text>
        </view>
        <view class="info-row" wx:if="{{templateDisplay && templateDisplay.lightingRequirements}}">
          <text class="info-label">灯光要求：</text>
          <text class="info-value">{{templateDisplay.lightingRequirements}}</text>
        </view>
        <view class="info-row" wx:if="{{templateDisplay && templateDisplay.backgroundMusic}}">
          <text class="info-label">背景音乐：</text>
          <text class="info-value">{{templateDisplay.backgroundMusic}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- Scenes List -->
  <view class="scenes-container" wx:if="{{!loading}}">
    <view class="scenes-header">
      <text class="scenes-title">场景</text>
      <text class="scenes-subtitle">点击"录制"开始拍摄每个场景</text>
    </view>

    <view class="scenes-list">
      <view wx:for="{{scenes}}" wx:key="index" class="scene-item">
        
        <!-- Scene Content without video on left -->
        <view class="scene-content-wrapper">
            <!-- Scene Header -->
            <view class="scene-header">
          <!-- Similarity in header top-right (replaces old mark) -->
          <view class="status-indicator" wx:if="{{submissions[index + 1] && (submissions[index + 1].hasScore || submissions[index + 1].isCalculating)}}">
            <text class="similarity-badge" wx:if="{{submissions[index + 1].isCalculating}}">视频相似度: ..</text>
            <text class="similarity-badge" wx:else>视频相似度: {{submissions[index + 1].similarityPercent}}%</text>
          </view>
          <view class="scene-number-container">
            <view class="scene-number">{{index + 1}}</view>
          </view>
          
          <view class="scene-title-container">
            <text class="scene-title">{{item.sceneTitle || '场景 ' + (index + 1)}}</text>
            <view class="status-badge {{submissions[index + 1] ? submissions[index + 1].statusClass : 'status-pending'}}">
              {{submissions[index + 1] ? submissions[index + 1].statusText : '未提交'}}
            </view>
          </view>
        </view>

        <!-- Scene Content (no inline AI suggestions; moved to modal) -->
        <view class="scene-content" wx:if="{{submissions[index + 1]}}"></view>

            <!-- Scene Actions -->
            <view class="scene-actions">
              <!-- Example column: 查看录制 (top) + 案例 (main) -->
              <view class="btn-wrap example-wrap stacked">
                <custom-button
                  wx:if="{{submissions[index + 1] && (submissions[index + 1].videoUrl || submissions[index + 1].sceneId)}}"
                  text="查看录制"
                  type="outline"
                  size="small"
                  ext-class="block-btn top-btn"
                  data-index="{{index}}"
                  catch:tap="viewRecorded">
                </custom-button>
                <custom-button
                  wx:if="{{template && (videoUrl || template.videoUrl || (templateType === 'manual' && item.videoId))}}"
                  text="案例"
                  type="outline"
                  size="small"
                  ext-class="block-btn"
                  data-index="{{index}}"
                  data-start-time="{{item.startTimeMs || 0}}"
                  data-end-time="{{item.endTimeMs || 3000}}"
                  catch:tap="playSceneExample">
                </custom-button>
              </view>

              <!-- Record column: AI建议 (top) + 开始录制 (main) -->
              <view class="btn-wrap record-wrap stacked">
                <custom-button
                  wx:if="{{submissions[index + 1] && submissions[index + 1].aiSuggestions && submissions[index + 1].aiSuggestions.length > 0}}"
                  text="AI建议"
                  type="outline"
                  size="small"
                  ext-class="block-btn top-btn"
                  data-index="{{index}}"
                  catch:tap="openAISuggestions">
                </custom-button>
                <custom-button
                  text="开始录制"
                  type="danger-outline"
                  size="default"
                  ext-class="block-btn"
                  data-index="{{index}}"
                  catch:tap="recordScene">
                </custom-button>
              </view>
            </view>
        </view>
      </view>
    </view>
  </view>

  <!-- Overall Progress -->
  <view class="progress-summary" wx:if="{{!loading && progress}}">
    <view class="progress-card">
      <view class="progress-header">
        <text class="progress-title">总体进度</text>
        <text wx:if="{{publishStatus === 'approved'}}" class="scenes-subtitle">（等待人工审核中）</text>
      </view>
      <view class="progress-stats">
        <view class="stat-item">
          <text class="stat-number">{{progress.approved}}</text>
          <text class="stat-label">已通过</text>
        </view>
        <view class="stat-item">
          <text class="stat-number">{{progress.pending}}</text>
          <text class="stat-label">待审核</text>
        </view>
        <view class="stat-item">
          <text class="stat-number">{{progress.approved}}/{{progress.totalScenes}}</text>
          <text class="stat-label">完成度</text>
        </view>
      </view>
    </view>
  </view>
  
  <!-- Example Video Modal -->
  <view class="example-modal" wx:if="{{showExampleModal}}" catchtouchmove="true">
    <view class="modal-overlay" bindtap="closeExampleModal"></view>
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">{{currentExampleScene.title}} - 案例</text>
        <view class="close-button" bindtap="closeExampleModal">✕</view>
      </view>
      
      <view class="video-container">
        <video 
          id="exampleVideo"
          class="example-video"
          src="{{currentExampleScene.videoUrl}}"
          initial-time="{{ currentExampleScene.startTimeMs/1000 }}"
          show-progress="{{true}}"
          show-fullscreen-btn="{{false}}"
          show-play-btn="{{true}}"
          show-center-play-btn="{{true}}"
          controls="{{true}}"
          bindloadedmetadata="onExampleVideoLoaded"
          bindplay="onExampleVideoPlay"
          bindtimeupdate="onExampleVideoTimeUpdate"
          binderror="onVideoError"
        >
        </video>
        
        <view wx:if="{{!currentExampleScene.videoUrl}}" class="video-error">
          <text>视频暂不可用</text>
        </view>
        <view class="time-info" wx:if="{{currentExampleScene && currentExampleScene.endTimeMs > 0}}">
          <text class="time-label">场景时间段: {{currentExampleScene.startTimeMs/1000}}s - {{currentExampleScene.endTimeMs/1000}}s</text>
        </view>
      </view>
    </view>
  </view>

  <!-- AI Suggestions Modal (styled like camera recording-complete) -->
  <view class="recording-complete-overlay" wx:if="{{showSuggestionsModal}}" catchtouchmove="true">
    <view class="recording-complete-modal">
      <view class="recording-complete-header">
        <text class="recording-complete-title">AI建议</text>
      </view>
      <view class="recording-complete-body">
        <block wx:if="{{currentAISuggestions && currentAISuggestions.length > 0}}">
          <view class="suggestions-list-modal">
            <text wx:for="{{currentAISuggestions}}" wx:key="index" class="suggestion-line">{{item}}</text>
          </view>
        </block>
      </view>
      <view class="recording-complete-actions">
        <button class="recording-action-btn submit-btn" bindtap="closeAISuggestions">好的</button>
  </view>

  <!-- Recorded Video Modal (same style as Example modal) -->
  <view class="example-modal" wx:if="{{showRecordedModal}}" catchtouchmove="true">
    <view class="modal-overlay" bindtap="closeRecordedModal"></view>
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">{{currentRecordedScene.title}} - 查看录制</text>
        <view class="close-button" bindtap="closeRecordedModal">✕</view>
      </view>
      
      <view class="video-container">
        <video 
          id="recordedVideo"
          class="example-video"
          src="{{currentRecordedScene.videoUrl}}"
          show-progress="{{true}}"
          show-fullscreen-btn="{{false}}"
          show-play-btn="{{true}}"
          show-center-play-btn="{{true}}"
          controls="{{true}}"
        >
        </video>
      </view>
    </view>
  </view>
</view>
  </view>

  
</view>
